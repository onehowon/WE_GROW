name: Sync Jira on PR events

on:
  pull_request:
    types: [opened, reopened, closed]

permissions:
  contents: read

jobs:
  jira-pr-sync:
    runs-on: ubuntu-latest
    env:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    steps:
      - name: Extract Jira key from PR title
        id: extract-key
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR_TITLE=$PR_TITLE"
          # [WEG-4] 처럼 대괄호 안의 키를 찾는다
          KEY=$(echo "$PR_TITLE" | grep -oE '[A-Z]+-[0-9]+')
          echo "JIRA_KEY=$KEY" >> $GITHUB_ENV

      - name: Check Jira key exists
        run: |
          if [ -z "${JIRA_KEY}" ]; then
            echo "No JIRA key found in PR title. Skip."
            exit 0
          fi

      - name: Jira login check
        run: |
          curl --fail --request GET \
            --url "https://${JIRA_BASE_URL}/rest/api/3/myself" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json"

      # PR 열릴 때 / reopened → 리뷰 중(or 진행 중) 상태로 전환 + 댓글
      - name: Move Jira issue to In Review on PR opened
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        run: |
          JIRA_KEY="${JIRA_KEY}"

          IN_REVIEW_ID="31"

          echo "Move $JIRA_KEY to In Review (transition: $IN_REVIEW_ID)"

          # 상태 전환
          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"transition\": { \"id\": \"${IN_REVIEW_ID}\" }
            }"

          # Jira 코멘트 추가 (선택)
          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/comment" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"body\": \"PR #${{ github.event.pull_request.number }} opened: ${{ github.event.pull_request.html_url }}\"
            }"

      # PR이 closed + merged == true → 완료 상태로 전환
      - name: Move Jira issue to Done on PR merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          JIRA_KEY="${JIRA_KEY}"

          # 여기 값을 "완료" transition id로 바꿔라
          DONE_ID="41"

          echo "Move $JIRA_KEY to Done (transition: $DONE_ID)"

          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"transition\": { \"id\": \"${DONE_ID}\" }
            }"

          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/comment" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"body\": \"PR #${{ github.event.pull_request.number }} merged: ${{ github.event.pull_request.html_url }}\"
            }"
