name: Sync Jira on PR events

on:
  pull_request:
    types: [opened, reopened, closed]

permissions:
  contents: read

jobs:
  jira-pr-sync:
    runs-on: ubuntu-latest
    env:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}      # 예: ajou-team-niy9vdqg.atlassian.net
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    steps:
      # 1) PR 제목에서 [WEG-4] 같은 JIRA 키 추출
      - name: Extract Jira key from PR title
        id: extract-key
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "PR_TITLE=$PR_TITLE"

          # [WEG-4] 또는 WEG-4 형식의 키를 추출
          KEY=$(echo "$PR_TITLE" | grep -oE '[A-Z]+-[0-9]+' || true)

          if [ -z "$KEY" ]; then
            echo "No JIRA key found in PR title. (expected like: [WEG-4])"
          else
            echo "Found JIRA key: $KEY"
          fi

          echo "JIRA_KEY=$KEY" >> $GITHUB_ENV

      # 2) Jira 키가 없으면 그냥 스킵
      - name: Stop if no Jira key
        run: |
          if [ -z "$JIRA_KEY" ]; then
            echo "JIRA_KEY is empty. Skip Jira sync."
            exit 0
          fi
          echo "JIRA_KEY=$JIRA_KEY"

      # 3) Jira 로그인 체크
      - name: Jira login check
        run: |
          curl --fail --request GET \
            --url "https://${JIRA_BASE_URL}/rest/api/3/myself" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json"

      # 4) PR open / reopen 시 → Jira 이슈를 "진행 중"으로 이동 + PR opened 댓글
      - name: Move Jira issue to In Progress on PR opened
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        run: |
          echo "Find transition to '진행 중' for $JIRA_KEY"

          TRANSITIONS=$(curl --fail --silent --request GET \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json")

          echo "Available transitions:"
          echo "$TRANSITIONS" | jq '.transitions[] | {id, name, to: .to.name}'

          INPROG_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.to.name=="진행 중") | .id')

          if [ -z "$INPROG_ID" ]; then
            echo "No transition to '진행 중' found. Skip."
            exit 0
          fi

          echo "Move $JIRA_KEY to '진행 중' (transition id: $INPROG_ID)"

          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"transition\": { \"id\": \"${INPROG_ID}\" }
            }"

          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/comment" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"body\": \"PR #${{ github.event.pull_request.number }} opened: ${{ github.event.pull_request.html_url }}\"
            }"

      # 5) PR closed + merged == true → Jira 이슈를 "완료"로 이동 + PR merged 댓글
      - name: Move Jira issue to Done on PR merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          echo "Find transition to '완료' for $JIRA_KEY"

          TRANSITIONS=$(curl --fail --silent --request GET \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json")

          echo "Available transitions:"
          echo "$TRANSITIONS" | jq '.transitions[] | {id, name, to: .to.name}'

          DONE_ID=$(echo "$TRANSITIONS" | jq -r '.transitions[] | select(.to.name=="완료") | .id')

          if [ -z "$DONE_ID" ]; then
            echo "No transition to '완료' found. Skip."
            exit 0
          fi

          echo "Move $JIRA_KEY to '완료' (transition id: $DONE_ID)"

          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"transition\": { \"id\": \"${DONE_ID}\" }
            }"

          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/comment" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"body\": \"PR #${{ github.event.pull_request.number }} merged: ${{ github.event.pull_request.html_url }}\"
            }"
