name: Sync Jira on PR events

on:
  pull_request:
    types: [opened, reopened, closed]

permissions:
  contents: read

jobs:
  jira-pr-sync:
    runs-on: ubuntu-latest
    env:
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

    steps:
      - name: Extract Jira key from PR title or branch
        id: extract-key
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          BRANCH="${{ github.head_ref }}"
          echo "PR_TITLE=$PR_TITLE"
          echo "BRANCH=$BRANCH"

          KEY=$(echo "$PR_TITLE" | grep -oiE '[A-Z]+-[0-9]+' | head -n1 || true)
          if [ -z "$KEY" ]; then
            KEY=$(echo "$BRANCH" | grep -oiE '[A-Z]+-[0-9]+' | head -n1 || true)
          fi

          echo "Found JIRA key: $KEY"
          echo "JIRA_KEY=$KEY" >> $GITHUB_ENV

      - name: Stop if no Jira key
        run: |
          if [ -z "$JIRA_KEY" ]; then
            echo "JIRA_KEY empty → skip"
            exit 0
          fi

      - name: Jira login check
        run: |
          curl --fail --request GET \
            --url "https://${JIRA_BASE_URL}/rest/api/3/myself" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json"

      # ==============================
      #  PR OPEN → "진행 중"으로 이동
      # ==============================
      - name: Move Jira issue to In Progress on PR opened
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        run: |
          echo "Find transition to '진행 중' for $JIRA_KEY"

          URL="https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions"

          RESPONSE=$(curl --silent --show-error --write-out "HTTP_STATUS:%{http_code}" \
            --request GET \
            --url "$URL" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json")

          BODY=$(echo "$RESPONSE" | sed -e 's/HTTP_STATUS\:.*//g')
          STATUS=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTP_STATUS://')

          echo "HTTP_STATUS=$STATUS"
          echo "$BODY" | jq '.transitions[] | {id,name,to: .to.name}'

          INPROG_ID=$(echo "$BODY" | jq -r '.transitions[] | select(.to.name=="진행 중") | .id')

          echo "INPROG_ID=$INPROG_ID"

          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"transition\": { \"id\": \"${INPROG_ID}\" }
            }"

      # ==============================
      # PR MERGED → "완료"로 이동
      # ==============================
      - name: Move Jira issue to Done on PR merged
        if: github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          echo "Find transition to '완료' for $JIRA_KEY"

          URL="https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions"

          RESPONSE=$(curl --silent --show-error --write-out "HTTP_STATUS:%{http_code}" \
            --request GET \
            --url "$URL" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json")

          BODY=$(echo "$RESPONSE" | sed -e 's/HTTP_STATUS\:.*//g')
          STATUS=$(echo "$RESPONSE" | tr -d '\n' | sed -e 's/.*HTTP_STATUS://')

          echo "HTTP_STATUS=$STATUS"
          echo "$BODY" | jq '.transitions[] | {id,name,to: .to.name}'

          DONE_ID=$(echo "$BODY" | jq -r '.transitions[] | select(.to.name=="완료") | .id')
          echo "DONE_ID=$DONE_ID"

          # transition 실행
          curl --fail --silent --request POST \
            --url "https://${JIRA_BASE_URL}/rest/api/3/issue/${JIRA_KEY}/transitions" \
            --user "${JIRA_USER_EMAIL}:${JIRA_API_TOKEN}" \
            --header "Accept: application/json" \
            --header "Content-Type: application/json" \
            --data "{
              \"transition\": { \"id\": \"${DONE_ID}\" }
            }"
